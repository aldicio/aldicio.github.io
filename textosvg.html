<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LaTeX para SVG</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 40px; background-color: #f4f4f9; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 600px; margin: auto; }
        textarea { width: 100%; height: 120px; border: 1px solid #ccc; border-radius: 4px; padding: 10px; box-sizing: border-box; font-family: monospace; }
        .button-group { margin-top: 15px; display: flex; gap: 10px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-convert { background-color: #28a745; color: white; }
        .btn-download { background-color: #007bff; color: white; display: none; }
        #svg-output { margin-top: 20px; text-align: center; overflow: auto; padding: 10px; background: #fff; border: 1px dashed #bbb; }
    </style>
</head>
<body>

<div class="card">
    <h2>Conversor de LaTeX para SVG</h2>
    <textarea id="latex-input" placeholder="Digite seu código LaTeX aqui... (ex: \int_0^\infty e^{-x^2} dx)">\int_a^bf(x)dx= F(b)-F(a)</textarea>
    
    <div class="button-group">
        <button py-click="convert_latex" class="btn-convert">Visualizar</button>
        <button py-click="download_svg" id="btn-download" class="btn-download">Baixar .svg</button>
    </div>

    <div id="svg-output">
        <small style="color: #666;">O resultado aparecerá aqui</small>
    </div>
    <div id="svg-output">
        <small style="color: #118;">Este conversor usa a biblioteca <a href="https://www.mathjax.org/" target="_blank">MathJax</a> </small>
    </div>
</div>

<script type="py">
    from pyscript import document, window
    import binascii

    def convert_latex(event):
        input_text = document.querySelector("#latex-input").value
        output_div = document.querySelector("#svg-output")
        btn_download = document.querySelector("#btn-download")
        
        mathjax = window.MathJax
        
        if mathjax:
            output_div.innerHTML = ""
            # Gera o container SVG do MathJax
            svg_container = mathjax.tex2svg(input_text)
            output_div.appendChild(svg_container)
            
            # Mostra o botão de download
            btn_download.style.display = "block"
        else:
            output_div.innerHTML = "Erro ao carregar MathJax."

    def download_svg(event):
        # 1. Capturar o elemento <svg> de dentro do container gerado pelo MathJax
        svg_element = document.querySelector("#svg-output svg")
        
        if svg_element:
            # 2. Obter o conteúdo XML do SVG
            svg_data = svg_element.outerHTML
            
            # Adicionar o namespace XML se não estiver presente (importante para compatibilidade)
            if 'xmlns="http://www.w3.org/2000/svg"' not in svg_data:
                svg_data = svg_data.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg"')

            # 3. Criar o Blob e o link de download usando JS via PyScript
            blob = window.Blob.new([svg_data], { 'type': 'image/svg+xml' })
            url = window.URL.createObjectURL(blob)
            
            # 4. Criar um link temporário para o disparo do download
            link = document.createElement('a')
            link.href = url
            link.download = "formula.svg"
            document.body.appendChild(link)
            link.click()
            
            # Limpeza
            document.body.removeChild(link)
            window.URL.revokeObjectURL(url)

</script>

</body>
</html>